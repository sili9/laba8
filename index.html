<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Модель с эффектами</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        model-viewer {
            width: 100%;
            height: 70vh;
            background-color: #f0f0f0;
            margin-bottom: 20px;
        }
        .controls {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            background: #6200ee;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button.active {
            background: #03dac6;
            color: black;
        }
    </style>
</head>
<body>
    <h1>3D Модель с эффектами Bloom и Outline</h1>
    
    <!-- Model Viewer с эффектами -->
    <model-viewer
        id="model"
        src="Low poly spring scene3.glb"
        camera-controls
        auto-rotate
        ar
        shadow-intensity="1"
        alt="3D модель весны"
    >
        <effect-composer>
            <bloom-effect strength="1.0" radius="0.5" threshold="0.8"></bloom-effect>
            <outline-effect color="#ffffff" strength="2.0"></outline-effect>
        </effect-composer>
    </model-viewer>

    <div class="controls">
        <button id="bloom-btn">Bloom: Вкл</button>
        <button id="outline-btn">Outline: Вкл</button>
    </div>

    <!-- Полифилл для Safari -->
    <script async src="https://unpkg.com/es-module-shims@1.7.1/dist/es-module-shims.js"></script>

    <!-- Импорт-карта с правильными версиями -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.132.2/build/three.module.min.js",
            "@google/model-viewer": "https://unpkg.com/@google/model-viewer@1.11.1/dist/model-viewer.min.js",
            "@google/model-viewer-effects": "https://unpkg.com/@google/model-viewer-effects@0.4.0/dist/model-viewer-effects.min.js"
        }
    }
    </script>

    <!-- Основной скрипт -->
    <script type="module">
        // Импортируем необходимые компоненты
        import { ModelViewerElement } from '@google/model-viewer';
        import '@google/model-viewer-effects';

        // Ждем загрузки компонентов
        await Promise.all([
            customElements.whenDefined('model-viewer'),
            customElements.whenDefined('effect-composer')
        ]);

        const modelViewer = document.querySelector("#model");
        const bloomEffect = modelViewer.querySelector('bloom-effect');
        const outlineEffect = modelViewer.querySelector('outline-effect');
        const bloomBtn = document.querySelector("#bloom-btn");
        const outlineBtn = document.querySelector("#outline-btn");

        // Состояние эффектов
        const effectsState = {
            bloom: true,
            outline: true
        };

        // Управление Bloom
        bloomBtn.addEventListener('click', () => {
            effectsState.bloom = !effectsState.bloom;
            bloomEffect.blendMode = effectsState.bloom ? 'default' : 'skip';
            bloomBtn.textContent = `Bloom: ${effectsState.bloom ? 'Вкл' : 'Выкл'}`;
            bloomBtn.classList.toggle('active', effectsState.bloom);
        });

        // Управление Outline
        outlineBtn.addEventListener('click', () => {
            effectsState.outline = !effectsState.outline;
            outlineEffect.blendMode = effectsState.outline ? 'default' : 'skip';
            outlineBtn.textContent = `Outline: ${effectsState.outline ? 'Вкл' : 'Выкл'}`;
            outlineBtn.classList.toggle('active', effectsState.outline);
        });

        // Обработчик ошибок
        modelViewer.addEventListener('error', (event) => {
            console.error('Ошибка загрузки модели:', event.detail);
            alert(`Ошибка: ${event.detail}`);
        });

        // Инициализация кнопок
        bloomBtn.classList.add('active');
        outlineBtn.classList.add('active');
    </script>
</body>
</html>
